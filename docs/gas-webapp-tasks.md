# YOKIN 実装タスクリスト（改訂版）

## Phase 1: 基盤構築

### 1-1. GASプロジェクト基本構成
- [ ] **1-1-1** ローカルに `gas-webapp/` フォルダ作成
- [ ] **1-1-2** `コード.gs` に `doGet()` 関数作成
- [ ] **1-1-3** `無題.html` のUI骨格作成（キムラ式テンプレート適用）
- [ ] **1-1-4** フォレストグリーン配色CSS実装（ライト/ダーク両テーマ）
- [ ] **1-1-5** ロード画面実装（account_balanceアイコン + パルスアニメーション）
- [ ] **1-1-6** テーマ切り替え機能実装（localStorage保存/復元）
- [ ] **1-1-7** 設定モーダル実装（テーマ・フォント選択、初期化ボタン）
- [ ] **1-1-8** Driver.jsツアー実装（7ステップ）

### 1-2. マスターデータ管理
- [ ] **1-2-1** `initializeMasterData()` 関数実装（6シート自動作成）
- [ ] **1-2-2** 勘定科目シート初期データ投入
- [ ] **1-2-3** 補助科目シート初期データ投入
- [ ] **1-2-4** 店舗マスターシート初期データ投入
- [ ] **1-2-5** 仕訳ルールシート初期データ投入
- [ ] **1-2-6** 税区分マスターシート初期データ投入
- [ ] **1-2-7** `getAccountMaster()` 関数実装
- [ ] **1-2-8** `getSubAccountMaster(accountId)` 関数実装
- [ ] **1-2-9** `getStoreMaster()` 関数実装
- [ ] **1-2-10** `getJournalRules()` 関数実装
- [ ] **1-2-11** `getTaxCategoryMaster()` 関数実装

---

## Phase 2: フォルダ・PDF選択機能

### 2-1. Google Drive連携
- [ ] **2-1-1** `getPickerOAuthToken()` 関数実装
- [ ] **2-1-2** Google Picker API読み込み（クライアント側）
- [ ] **2-1-3** `openFolderPicker()` 関数実装（フォルダ選択UI）
- [ ] **2-1-4** フォルダID直接入力フォーム実装
- [ ] **2-1-5** `getPdfListFromFolder(folderId)` 関数実装

### 2-2. PDF一覧・科目設定画面
- [ ] **2-2-1** PDF一覧テーブルUI実装
- [ ] **2-2-2** `detectStoreFromFilename(filename)` 関数実装（店舗自動判別）
- [ ] **2-2-3** 勘定科目ドロップダウン実装（マスター連動）
- [ ] **2-2-4** 補助科目ドロップダウン実装（勘定科目連動）
- [ ] **2-2-5** 全選択/選択解除ボタン実装
- [ ] **2-2-6** `navigateToStep()` 関数実装（ステップ間移動）

### 2-3. 日付範囲選択画面
- [ ] **2-3-1** カレンダーUI実装（デュアルカレンダー）
- [ ] **2-3-2** `selectPreviousMonth(monthsAgo)` 関数実装（先月/先々月ボタン）
- [ ] **2-3-3** 日付範囲ハイライト表示
- [ ] **2-3-4** 開始日/終了日入力フィールド連動

---

## Phase 3: OCR・解析機能

### 3-1. Gemini API連携
- [ ] **3-1-1** Gemini API認証設定（PropertiesServiceにAPIキー保存）
- [ ] **3-1-2** PDFから画像変換処理（PDF.js使用、クライアントサイド）
- [ ] **3-1-3** `callGeminiApi(base64Image, prompt)` 関数実装
- [ ] **3-1-4** OCRプロンプト最適化（bank-statement-processor仕様参照）
- [ ] **3-1-5** 複数ページPDF対応（ページごとに画像変換・OCR）

### 3-2. データ処理ロジック
- [ ] **3-2-1** `parseOcrResult(ocrText, storeId)` 関数実装
- [ ] **3-2-2** レイアウト判別ロジック（3パターン並列評価）
- [ ] **3-2-3** 日付正規化 `normalizeDate(dateStr)` （元号→西暦変換: R/H/S対応）
- [ ] **3-2-4** 金額正規化 `normalizeAmount(amountStr)` （カンマ除去、全角→半角）
- [ ] **3-2-5** 摘要正規化（振込先情報保持）

### 3-3. 整合性チェック・信頼度判定
- [ ] **3-3-1** `validateTransactions(data)` 関数実装（残高整合性チェック）
- [ ] **3-3-2** `autoCorrectOcrError(row, expectedBalance)` 関数実装（1桁OCR誤読補正）
- [ ] **3-3-3** `calculateConfidenceScore(row, prevRow)` 関数実装（信頼度判定）
- [ ] **3-3-4** 信頼度フラグ付与ロジック（高🟢/中🟡/低🔴）

### 3-4. 解析結果表示UI
- [ ] **3-4-1** 解析実行画面UI（プログレスバー、ステータス表示）
- [ ] **3-4-2** `updateProgress(current, total, message)` 関数実装
- [ ] **3-4-3** 解析結果テーブルUI（信頼度アイコン付き）
- [ ] **3-4-4** 店舗タブ切り替え実装
- [ ] **3-4-5** `filterByConfidence(level)` 関数実装（低信頼度フィルター）
- [ ] **3-4-6** セル編集機能（インライン編集）

---

## Phase 4: 仕訳ルール機能

### 4-1. ルールマッチング
- [ ] **4-1-1** `applyJournalRules(transactions, storeId)` 関数実装
- [ ] **4-1-2** `matchJournalRule(description, amount, isDeposit, storeId)` 関数実装
- [ ] **4-1-3** パターン種別対応（完全一致/部分一致/正規表現）
- [ ] **4-1-4** 優先度によるルールソート
- [ ] **4-1-5** 補助科目の店舗連動解決 `resolveSubAccount()` 関数実装

### 4-2. ルール設定ダイアログ
- [ ] **4-2-1** 新規ルール設定ダイアログUI
- [ ] **4-2-2** パターン種別ラジオボタン実装
- [ ] **4-2-3** 借方/貸方勘定科目ドロップダウン実装
- [ ] **4-2-4** 借方/貸方補助科目ドロップダウン（{店舗名}連動オプション含む）
- [ ] **4-2-5** 借方/貸方部門ドロップダウン実装（支払手数料など部門が必要な場合用）
- [ ] **4-2-6** 税区分ドロップダウン実装
- [ ] **4-2-7** 「この行のみ適用」ボタン機能
- [ ] **4-2-8** 「保存」ボタン機能（マスターへ新規ルール追加）

### 4-3. ルール管理画面
- [ ] **4-3-1** ルール管理画面UI（一覧テーブル）
- [ ] **4-3-2** `saveJournalRule(ruleData)` 関数実装
- [ ] **4-3-3** `updateJournalRule(ruleId, ruleData)` 関数実装
- [ ] **4-3-4** `deleteJournalRule(ruleId)` 関数実装
- [ ] **4-3-5** ルール編集ダイアログ
- [ ] **4-3-6** ルール削除確認ダイアログ
- [ ] **4-3-7** ルール検索機能

---

## Phase 5: 出力・仕上げ

### 5-1. 弥生会計変換
- [ ] **5-1-1** `convertToYayoiFormat(journalEntries)` 関数実装（25項目形式）
- [ ] **5-1-2** 弥生会計形式バリデーション
- [ ] **5-1-3** 0円行スキップ処理

### 5-2. スプレッドシート出力
- [ ] **5-2-1** `createOutputSpreadsheet(title)` 関数実装（新規SS作成）
- [ ] **5-2-2** `saveToSpreadsheet(ssId, data, sheetName)` 関数実装
- [ ] **5-2-3** 中間データシート出力（解析フラグ付き）
- [ ] **5-2-4** 最終仕訳シート出力

### 5-3. CSV出力
- [ ] **5-3-1** `convertToShiftJis(text)` 関数実装（UTF-8→Shift-JIS変換）
- [ ] **5-3-2** `generateYayoiCsv(yayoiData)` 関数実装（Shift-JIS + CRLF）
- [ ] **5-3-3** CSVダウンロード機能（クライアントサイド）
- [ ] **5-3-4** 中間データCSV出力（UTF-8）

### 5-4. 完了画面
- [ ] **5-4-1** 処理完了画面UI
- [ ] **5-4-2** 処理サマリー表示（件数、スキップ件数）
- [ ] **5-4-3** スプレッドシートリンク表示
- [ ] **5-4-4** 「新規処理を開始」ボタン
- [ ] **5-4-5** 「ルール管理へ」ボタン

### 5-5. 処理履歴
- [ ] **5-5-1** `saveProcessHistory(historyData)` 関数実装
- [ ] **5-5-2** 処理履歴シートへの書き込み

---

## Phase 6: テスト・調整

### 6-1. 単体テスト
- [ ] **6-1-1** マスターデータ読み書きテスト
- [ ] **6-1-2** 店舗自動判別テスト
- [ ] **6-1-3** ルールマッチングテスト
- [ ] **6-1-4** 残高整合性チェックテスト
- [ ] **6-1-5** 弥生会計形式変換テスト
- [ ] **6-1-6** Shift-JIS変換テスト

### 6-2. 統合テスト
- [ ] **6-2-1** 呑家PDFでの一連処理テスト
- [ ] **6-2-2** 西口アオギリPDFでの検証
- [ ] **6-2-3** ホドケバPDFでの検証
- [ ] **6-2-4** はんろくPDFでの検証
- [ ] **6-2-5** 警視鳥PDFでの検証
- [ ] **6-2-6** 複数店舗同時処理テスト

### 6-3. 弥生会計インポート検証
- [ ] **6-3-1** 生成CSVを弥生会計で試験インポート
- [ ] **6-3-2** 文字化けチェック
- [ ] **6-3-3** 金額・日付の正確性確認
- [ ] **6-3-4** 勘定科目・補助科目の正確性確認

### 6-4. UI/UXテスト
- [ ] **6-4-1** テーマ切り替え動作確認
- [ ] **6-4-2** ツアー機能動作確認
- [ ] **6-4-3** 設定モーダル動作確認
- [ ] **6-4-4** ステップ間遷移テスト
- [ ] **6-4-5** エラー時のUI表示テスト
- [ ] **6-4-6** 信頼度フィルター動作確認

---

## Phase 7: デプロイ

- [ ] **7-1** Google Apps Script エディタで新規プロジェクト作成
- [ ] **7-2** `コード.gs` の内容をコピペ
- [ ] **7-3** `無題.html` ファイルを追加してコピペ
- [ ] **7-4** スクリプトプロパティに Gemini API キーを設定
- [ ] **7-5** スクリプトプロパティにマスターSS IDを設定
- [ ] **7-6** Webアプリとしてデプロイ
- [ ] **7-7** アクセス権限設定
- [ ] **7-8** 本番環境での動作確認

---

## 優先度・依存関係

```
Phase 1 (基盤) ─────────┐
                        │
Phase 2 (フォルダ選択) ─┤
         ↓              │
Phase 3 (OCR・解析) ────┤
         ↓              ├──→ Phase 6 (テスト)
Phase 4 (仕訳ルール) ───┤         ↓
         ↓              │    Phase 7 (デプロイ)
Phase 5 (出力) ─────────┘
```

---

## 完了条件

### 最低限の完了条件（MVP）
- [ ] PDFをGemini APIでOCRできる
- [ ] 残高整合性チェックが動作する
- [ ] 信頼度フラグが正しく付与される
- [ ] 仕訳ルールマッチングが動作する
- [ ] 新規ルール登録ダイアログが動作する
- [ ] 弥生会計形式CSVが出力できる（Shift-JIS + CRLF）
- [ ] 弥生会計にインポートできる

### 理想的な完了条件
- [ ] キムラ式UIが完全に動作（テーマ、ツアー、設定）
- [ ] 5店舗すべてのPDFを正しく処理できる
- [ ] ルール管理画面から仕訳ルールを編集・削除できる
- [ ] エラー時の適切なハンドリングとメッセージ表示
- [ ] 処理進捗が視覚的にわかる
- [ ] 処理履歴がスプレッドシートに記録される

---

## 関連ドキュメント

- `docs/gas-webapp-plan.md` - 詳細な実装計画
- `.claude/skills/gas-webapp-assistant/` - キムラ式UIテンプレート
- `.claude/skills/bank-to-yayoi/` - 弥生会計変換仕様
- `.claude/skills/bank-statement-processor/` - OCR処理仕様
- `agent_docs/g_銀行預金総合データ処理.md` - 残高整合性チェックアルゴリズム
