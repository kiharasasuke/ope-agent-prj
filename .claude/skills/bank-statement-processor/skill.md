---
name: bank-statement-processor
description: 銀行取引明細（PDF・通帳写真・スキャン画像）をOCR解析し、会計処理用CSVを生成するスキル。使用タイミング: (1) 銀行明細のPDFや画像からCSVを作成したい時 (2) 通帳のスキャン画像をデータ化したい時 (3) OCR結果の整合性チェック・自動補正が必要な時 (4) 複数銀行の明細を統一フォーマットで出力したい時
---

# 銀行取引明細 完全自動解析・CSV生成

銀行取引明細（PDF・通帳写真・スキャン画像）からOCR誤認識を補正し、会計処理用CSVを生成する。

## 入力データの場所

処理対象のPDFは `01_預金/` フォルダ内にある。まずこのフォルダの内容を確認すること。

## PDF読み込み（重要：大容量PDF対応）

銀行明細PDFはスキャン画像のため、**必ず`pdf-chunked-reader`スキルの画像変換モードを使用**する。
直接PDFをReadツールで読むと413エラーになる。

### 手順

**Step 1: PDFを画像に変換**
```bash
python .claude/skills/pdf-chunked-reader/scripts/safe_read_pdf.py "01_預金/XXX.pdf" --to-images --output-dir ./temp/images
```

**Step 2: 出力されたJSONから画像パスを取得**

出力例:
```json
{
  "success": true,
  "image_files": [
    {"page": 1, "file_path": "C:/path/to/temp/images/page_001.jpg"},
    {"page": 2, "file_path": "C:/path/to/temp/images/page_002.jpg"}
  ]
}
```

**Step 3: 各画像をReadツールで読み込み**

`image_files`の各`file_path`を順番にReadツールで読み込む。

**Step 4: 全ページの処理完了後、一時画像を削除**

## 期間指定

処理開始前にユーザーに出力対象期間を確認する。

### 確認事項
- **開始日**: 出力対象の開始日（例: 2025/11/01）
- **終了日**: 出力対象の終了日（例: 2025/12/31）

### フィルタリングルール
- 指定期間外の取引行はCSV出力から除外
- 整合性チェック・残高計算は全データで実施（期間外も含む）
- 期間開始日の前日残高を「繰越残高」として保持
- 期間指定なしの場合は全期間を出力

### 出力時の注意
- CSVの先頭行は期間開始日時点の残高から開始
- 期間外の取引で残高計算に影響がある場合は内部で考慮

## 処理フロー（必須順序）

1. レイアウト仮説生成（複数パターン並列評価）
2. レイアウト別全文字OCR
3. 正規化（文字・日付・数値）
4. 整合性チェック
5. 数学的逆算補正
6. 重複検出・排除
7. 最終CSV生成

## レイアウト判別

### 仮説パターン（最低3種を並列評価）

| パターン | 特徴 |
|---------|------|
| A | 入金列／出金列が別 |
| B | 金額列1つ、符号（＋/−）または摘要語で判別 |
| C | 色分け・記号（▲・△・＊等）で表現 |

### 採用判定基準

| 評価項目 | 条件 |
|---------|------|
| 日付連続性 | 日付が逆行しない |
| 残高整合率 | `前残高 + 入金 − 出金 = 次残高` 成立率 |
| 金額妥当性 | マイナス残高・同時入出金が存在しない |
| 摘要妥当性 | 金融用語辞書一致率 |

→ 合計スコア最大のパターンを採用

## OCR正規化ルール

### 濁点・半濁点補正
- 固有名詞は辞書一致優先（参照: [references/financial-institutions.md](references/financial-institutions.md)）
- 辞書不一致は元文字列を保持

### 英字・記号
- PAYPAY / AMAZON / ETC は原文保持
- 意味を持たない数字列は摘要から除外（金額誤認リスクがある場合は除外禁止）

## 日付変換

### 元号→西暦
| 元号 | 開始年 |
|-----|-------|
| R (令和) | 2019 |
| H (平成) | 1989 |
| S (昭和) | 1926 |

### 自動補正条件（すべて必須）
1. 年が基準年±3年を外れている
2. 前後行の日付が連続している
3. 補正後に残高計算が成立する

→ すべて満たす場合のみ補正、それ以外は元値採用

## 整合性チェック

### 数値整合性
- 入金額 ≥ 0
- 出金額 ≥ 0
- 入金と出金が同時に0以外は禁止
- 残高 ≥ 0（当座除く）

### 残高計算式
```
前行残高 + 入金額 − 出金額 = 当行残高
```
- 小数禁止、1円単位で一致必須

## 数学的逆算補正

### 修正優先順位
1. 入金額・出金額の1桁OCR誤読
2. 金額中の文字誤認（0↔6, 3↔8, 1↔7）
3. 残高

### 補正アルゴリズム
1. 不一致行を検出
2. 前後残高から理論上の正解金額を逆算
3. OCR結果との差分が ±1桁 または 文字置換1箇所 の場合のみ修正
4. 2箇所以上必要な場合は修正禁止

## エラーハンドリング

以下に該当する場合は該当行のみ除外、他は出力続行：
- 逆算補正が2箇所以上必要
- 日付が確定できない
- 全レイアウト仮説で整合率 < 95%

## 摘要欄ルール

- 摘要に金額を含めない
- 以下は保持: 手数料、利息、組戻、訂正
- 金額混在時: 数値のみ削除、文言は保持
- **振込先情報の保持（重要）**: 振込取引の場合、振込先名（例: ｱｵｷﾞﾘｺｰﾎﾟﾚ、アオギリコーポレーション）を必ず摘要に含める
  - 例: 「都度振込 ｱｵｷﾞﾘｺｰﾎﾟﾚ」「ATM振込 (ｶ)ｱｵｷﾞﾘｺｰﾎﾟﾚ」
  - 振込先情報は仕訳変換時に資金移動の判定に使用するため、省略禁止

## 重複排除

| 一致レベル | 条件 | 処理 |
|-----------|------|------|
| 強一致 | 日付・摘要・入出金額・残高 完全一致 | 自動排除 |
| 中一致 | 日付・摘要・入出金額 一致（連続行のみ） | 連続時のみ排除 |

## 出力形式

```csv
日付,摘要,出金額,入金額,残高
```

- UTF-8
- 数値はすべて整数
- 空欄・マスクは 0
- 繰越行・入出金0行は除外

### CSV出力順序（厳守）

**原則: 画像（通帳）に記載されている順序をそのまま維持する**

- 日付でソートしない
- 同一日付内の取引順序を勝手に並べ替えない
- 通帳の上から下への記載順 = CSVの出力順
- 複数ページにまたがる場合も、ページ1→ページ2→...の順序を維持

**理由**: 残高計算は取引順序に依存するため、順序を変更すると整合性が崩れる

## 出力先・ファイル構成

### 出力フォルダ
- プロジェクトルートに `output/` フォルダを作成
- サブフォルダ構成: `output/{処理元フォルダ名}/`
- 例: `01_預金/` を処理 → `output/01_預金/` に出力

### ファイル命名規則
- 形式: `{店舗名}_{口座種別}_{出力期間}.csv`
- 店舗名: PDFファイル名から抽出（例: `01_呑家_202511-1.pdf` → `呑家`）
- 出力期間: `YYYYMM-YYYYMM` 形式（例: `202511-202512`）
- 例: `呑家_普通預金_202511-202512.csv`

### 店舗名・口座情報の判別方法
1. PDFファイル名から店舗名を抽出（`XX_店舗名_YYYYMM` 形式を想定）
2. 通帳ヘッダーから口座種別を抽出（普通預金、当座預金など）
3. 判別不能な場合は `unknown` を使用

## CSV生成スクリプト

CSV整合性検証には [scripts/validate_csv.py](scripts/validate_csv.py) を使用。

## 処理原則

論理的に確定できるものだけを、100%の確度で出力する。「迷ったら止める」ではなく「確定できるものは必ず出力」する。
