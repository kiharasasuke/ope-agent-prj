# GAS Webアプリ実装計画: 仕訳マイスター

## 概要

銀行取引明細PDFをGemini APIでOCR処理し、弥生会計インポート用CSV（25項目形式）を生成するGoogle Apps Script Webアプリ

## 要件

| 項目 | 内容 |
|------|------|
| アプリ名 | 仕訳マイスター |
| 入力 | Googleドライブ内のPDF（銀行取引明細） |
| 対象店舗 | 呑家、西口アオギリ、ホドケバ、はんろく、警視鳥 |
| OCR | Gemini API (gemini-pro-vision) |
| 出力1 | Googleスプレッドシート（新規作成して処理結果表示） |
| 出力2 | 弥生会計形式CSV（Shift-JIS, CRLF） |
| UI | キムラ式デザイン（フォレストグリーン配色） |
| 実行方式 | Webアプリとして公開 |

---

## ファイル構成

```
GASプロジェクト/
├── コード.gs          # サーバーサイド処理
└── 無題.html          # クライアントUI（HTML/CSS/JS統合）
```

---

## 主要関数設計

### コード.gs（サーバーサイド）

| 関数名 | 役割 |
|--------|------|
| `doGet()` | Webアプリエントリーポイント |
| `getPdfListFromDrive(folderId)` | DriveからPDF一覧取得 |
| `processPdfWithGemini(fileId)` | Gemini APIでOCR処理 |
| `parseOcrResult(ocrText)` | OCR結果をパース・正規化 |
| `validateAndCorrect(data)` | 残高整合性チェック・逆算補正 |
| `convertToYayoiFormat(data, storeName)` | 弥生会計形式に変換 |
| `createOutputSpreadsheet()` | 出力用スプレッドシート新規作成 |
| `saveToSpreadsheet(ssId, data, sheetName)` | スプレッドシートに保存 |
| `generateYayoiCsv(data)` | Shift-JIS + CRLF形式CSV生成 |

### 無題.html（クライアントサイド）

| 機能 | 実装内容 |
|------|----------|
| テーマ | ライト/ダーク切り替え（フォレストグリーン配色） |
| ロード画面 | account_balanceアイコン + パルスアニメーション |
| ツアー | Driver.js 7ステップ |
| 設定モーダル | テーマ・フォント選択、初期化 |
| 通信 | google.script.run でサーバー連携 |

---

## 処理フロー

```
1. ユーザーがDriveフォルダIDを入力
       ↓
2. PDF一覧を取得・表示（店舗自動判別）
       ↓
3. ユーザーが処理対象PDFを選択
       ↓
4. 各PDFをGemini APIでOCR
       ↓
5. OCR結果をパース・正規化
   - レイアウト判別（3パターン評価）
   - 日付変換（元号→西暦）
   - 金額正規化
       ↓
6. 残高整合性チェック・逆算補正
   - 前残高 + 入金 - 出金 = 当残高
   - 1桁誤読のみ自動補正
       ↓
7. 弥生会計形式に変換
   - 店舗→補助科目マッピング
   - 摘要→仕訳マッピング
       ↓
8. スプレッドシートに結果保存（新規作成）
       ↓
9. CSV（Shift-JIS, CRLF）ダウンロード
```

---

## 店舗マッピング

| 店舗名 | 普通預金の補助科目 | 現金の補助科目 |
|--------|-------------------|---------------|
| 呑家 | さわやか/呑家/1106478 | 呑家 |
| 西口アオギリ | さわやか/西口ｱｵｷﾞﾘ | 西口アオギリ |
| ホドケバ | さわやか/ﾎﾄﾞｹﾊﾞ/1119209 | ホドケバ |
| はんろく | 三井住友/はんろく | はんろく |
| 警視鳥 | さわやか/警視鳥 | 警視鳥 |

---

## 仕訳マッピング

| 摘要パターン | 借方 | 貸方 | 税区分 |
|-------------|------|------|--------|
| AD、ATM入金 | 普通預金(店舗名) | 現金 | 対象外 |
| ATM出金 | 小口現金(店舗名) | 普通預金(店舗名) | 対象外 |
| ｱｵｷﾞﾘｺｰﾎﾟﾚ含む | 普通預金(資金移動) | 普通預金(店舗名) | 対象外 |
| カード手数料 | 支払手数料 | 普通預金(店舗名) | 対象外 |

---

## UI画面設計

```
┌─────────────────────────────────────────────────────────────┐
│ [account_balance]  仕訳マイスター           [設定] [ヘルプ] │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. フォルダ選択                                      │   │
│  │    [Google DriveフォルダID入力] [読み込み]           │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. PDF選択                           [全選択] [解除] │   │
│  │  ☑ 01_呑家_202511.pdf          呑家       2025/11   │   │
│  │  ☑ 02_西口アオギリ_202512.pdf  西口ｱｵｷﾞﾘ  2025/12   │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 3. 処理オプション                                    │   │
│  │    出力先スプレッドシート: [自動作成]                │   │
│  └─────────────────────────────────────────────────────┘   │
│               [処理開始]                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 4. 処理結果                                          │   │
│  │    ■■■■■■■■□□ 80%                                   │   │
│  │    ✓ 呑家: 45件変換完了                              │   │
│  │    [スプレッドシートを開く] [CSVダウンロード]        │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│ Developed by kimura yoshiki                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 配色（フォレストグリーン）

### ライトテーマ
- 背景: `#f7faf8`
- カード: `rgba(255, 255, 255, 0.6)`
- テキスト: `#1a2e23`
- アクセント: `#15803d`

### ダークテーマ
- 背景: `#0f1a14`
- カード: `rgba(26, 46, 35, 0.7)`
- テキスト: `#ecfdf5`
- アクセント: `#22c55e`

---

## 技術的注意点

### GASの制限
- 実行時間: 6分制限（長時間処理は分割必要）
- Shift-JIS: ネイティブ非対応（文字コード変換必要）

### Gemini API
- モデル: gemini-pro-vision（画像入力対応）
- 画像サイズ: Base64で4MB以下推奨
- APIキー: PropertiesServiceで管理

### PDF処理
- GASではPDFの直接画像変換が困難
- 解決策: クライアントサイドでPDF.jsを使用してCanvas変換

---

## 検証方法

1. **OCR精度検証**: テストPDFで期待値との差異確認
2. **残高整合性検証**: 各行で `前残高 + 入金 - 出金 = 当残高` 検証
3. **弥生インポート検証**: 生成CSVを弥生会計で試験インポート
4. **UI検証**: テーマ切り替え、ツアー、設定保存の動作確認

---

## 参照ファイル

| ファイル | 用途 |
|----------|------|
| `.claude/skills/gas-webapp-assistant/references/html-template.md` | キムラ式UIテンプレート |
| `.claude/skills/gas-webapp-assistant/references/design-system.md` | CSSデザインシステム |
| `.claude/skills/bank-statement-processor/skill.md` | OCR処理・整合性チェック仕様 |
| `.claude/skills/bank-to-yayoi/SKILL.md` | 弥生会計変換仕様 |
