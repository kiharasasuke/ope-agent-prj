# 仕訳マイスター 実装タスクリスト

## Phase 1: 基盤構築

- [ ] **1-1** GASプロジェクト作成、基本ファイル構成（コード.gs、無題.html）
- [ ] **1-2** 無題.html のUI骨格作成（キムラ式テンプレート適用）
- [ ] **1-3** フォレストグリーン配色CSS実装（ライト/ダーク両テーマ）
- [ ] **1-4** ロード画面実装（account_balanceアイコン + パルスアニメーション）
- [ ] **1-5** テーマ切り替え機能実装（localStorage保存/復元）
- [ ] **1-6** 設定モーダル実装（テーマ・フォント選択、初期化ボタン）
- [ ] **1-7** Driver.jsツアー実装（7ステップ）

---

## Phase 2: DriveApp連携

- [ ] **2-1** `getPdfListFromDrive(folderId)` 関数実装
- [ ] **2-2** PDF一覧表示UI実装（ファイル名、店舗名、日付表示）
- [ ] **2-3** ファイル選択機能実装（チェックボックス、全選択/解除）
- [ ] **2-4** 店舗名自動判別ロジック実装（ファイル名から店舗特定）

---

## Phase 3: Gemini API OCR

- [ ] **3-1** Gemini API認証設定（PropertiesServiceにAPIキー保存）
- [ ] **3-2** PDFから画像変換処理（PDF.js使用、クライアントサイド）
- [ ] **3-3** `processPdfWithGemini(fileId)` 関数実装
- [ ] **3-4** OCRプロンプト最適化（bank-statement-processor仕様参照）
- [ ] **3-5** 複数ページPDF対応（ページごとに画像変換・OCR）

---

## Phase 4: データ処理ロジック

- [ ] **4-1** `parseOcrResult(ocrText)` 関数実装
- [ ] **4-2** レイアウト判別ロジック（3パターン並列評価）
- [ ] **4-3** 日付正規化（元号→西暦変換: R/H/S対応）
- [ ] **4-4** 金額正規化（カンマ除去、全角→半角）
- [ ] **4-5** 摘要正規化（振込先情報保持）
- [ ] **4-6** `validateAndCorrect(data)` 関数実装
- [ ] **4-7** 残高整合性チェック（前残高 + 入金 - 出金 = 当残高）
- [ ] **4-8** 逆算補正アルゴリズム実装（1桁OCR誤読のみ補正）

---

## Phase 5: 弥生会計変換

- [ ] **5-1** 店舗マッピング定義（5店舗の補助科目設定）
- [ ] **5-2** 摘要→仕訳マッピングロジック実装
  - AD/ATM入金 → 現金売上
  - ATM出金 → 小口現金
  - 資金移動（ｱｵｷﾞﾘｺｰﾎﾟﾚ）
  - 手数料
- [ ] **5-3** `convertToYayoiFormat(data, storeName)` 関数実装
- [ ] **5-4** 弥生会計25項目形式CSV生成ロジック

---

## Phase 6: 出力機能

- [ ] **6-1** `createOutputSpreadsheet()` 関数実装（新規シート作成）
- [ ] **6-2** `saveToSpreadsheet(ssId, data, sheetName)` 関数実装
- [ ] **6-3** Shift-JIS変換実装（文字コード変換テーブル）
- [ ] **6-4** `generateYayoiCsv(data)` 関数実装（CRLF改行）
- [ ] **6-5** CSVダウンロード機能（クライアントサイド）
- [ ] **6-6** 進捗表示UI実装（プログレスバー）
- [ ] **6-7** エラーハンドリング・結果表示UI

---

## Phase 7: テスト・調整

- [ ] **7-1** 単体テスト: 各関数の動作確認
- [ ] **7-2** 統合テスト: 呑家PDFでの一連処理テスト
- [ ] **7-3** 全店舗PDFでの検証（西口アオギリ、ホドケバ等）
- [ ] **7-4** 弥生会計インポート検証（実際にインポートして確認）
- [ ] **7-5** UI/UXテスト（テーマ、ツアー、設定の動作）
- [ ] **7-6** エッジケーステスト（エラー時の挙動、大量データ）

---

## Phase 8: デプロイ

- [ ] **8-1** Webアプリとしてデプロイ設定
- [ ] **8-2** アクセス権限設定
- [ ] **8-3** 本番環境での動作確認
- [ ] **8-4** ユーザーマニュアル作成（必要に応じて）

---

## 優先度・依存関係

```
Phase 1 (基盤) ─────┐
                    ├──→ Phase 7 (テスト)
Phase 2 (Drive) ────┤         ↓
       ↓            │    Phase 8 (デプロイ)
Phase 3 (OCR) ──────┤
       ↓            │
Phase 4 (処理) ─────┤
       ↓            │
Phase 5 (変換) ─────┤
       ↓            │
Phase 6 (出力) ─────┘
```

---

## 完了条件

### 最低限の完了条件（MVP）
- [ ] PDFをGemini APIでOCRできる
- [ ] 残高整合性チェックが動作する
- [ ] 弥生会計形式CSVが出力できる
- [ ] 弥生会計にインポートできる

### 理想的な完了条件
- [ ] キムラ式UIが完全に動作（テーマ、ツアー、設定）
- [ ] 5店舗すべてのPDFを正しく処理できる
- [ ] エラー時の適切なハンドリングとメッセージ表示
- [ ] 処理進捗が視覚的にわかる
